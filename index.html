<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ежедневник++</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA_E4t3RHWLNtorKm9utOyyRwojkUsUmis",
    authDomain: "telegramminiappdaily.firebaseapp.com",
    databaseURL: "https://telegramminiappdaily-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "telegramminiappdaily",
    storageBucket: "telegramminiappdaily.appspot.com",
    messagingSenderId: "324821981446",
    appId: "1:324821981446:web:bad97b2c34a73087e2e687"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const user = window.Telegram?.WebApp?.initDataUnsafe?.user || { id: "guest" };
  const userId = user.id;

  // DOM Elements
  const tasksContainer = document.getElementById('tasks');
  const inputTask = document.getElementById('inputTask');
  const btnAdd = document.getElementById('btnAdd');

  // Статусы
  const statuses = {
    todo: "В очереди",
    inprogress: "В работе",
    done: "Выполнено"
  };

  // Добавить задачу в БД
  function addTask(text) {
    if (!text.trim()) return;
    const id = Date.now().toString(); // простое уникальное id
    const taskRef = ref(db, `tasks/${userId}/${id}`);
    set(taskRef, {
      id,
      text,
      status: "todo",
      completed: false
    });
    inputTask.value = '';
  }

  // Обновить статус задачи
  function updateTaskStatus(taskId, newStatus) {
    const taskRef = ref(db, `tasks/${userId}/${taskId}`);
    update(taskRef, { status: newStatus });
  }

  // Отрисовка задач
  function renderTasks(tasks) {
    tasksContainer.innerHTML = '';

    Object.values(tasks).forEach(task => {
      const taskDiv = document.createElement('div');
      taskDiv.style.background = '#1f1f1f';
      taskDiv.style.borderRadius = '10px';
      taskDiv.style.padding = '10px';
      taskDiv.style.margin = '10px 0';
      taskDiv.style.display = 'flex';
      taskDiv.style.justifyContent = 'space-between';
      taskDiv.style.alignItems = 'center';

      // Текст задачи
      const textSpan = document.createElement('span');
      textSpan.textContent = task.text;
      textSpan.style.flex = '1';
      textSpan.style.cursor = 'pointer';

      // Статус (текст)
      const statusSpan = document.createElement('span');
      statusSpan.textContent = statuses[task.status];
      statusSpan.style.marginLeft = '15px';
      statusSpan.style.cursor = 'pointer';
      statusSpan.style.color = '#ccc';

      // При клике на статус показываем select
      statusSpan.addEventListener('click', () => {
        const select = document.createElement('select');
        Object.entries(statuses).forEach(([key, label]) => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = label;
          if (key === task.status) option.selected = true;
          select.appendChild(option);
        });
        statusSpan.replaceWith(select);

        select.focus();

        // При смене статуса обновляем в БД и возвращаем span
        select.addEventListener('change', () => {
          updateTaskStatus(task.id, select.value);
          select.replaceWith(statusSpan);
          statusSpan.textContent = statuses[select.value];
        });

        // Если уход с select без изменения, возвращаем span
        select.addEventListener('blur', () => {
          select.replaceWith(statusSpan);
        });
      });

      taskDiv.appendChild(textSpan);
      taskDiv.appendChild(statusSpan);

      tasksContainer.appendChild(taskDiv);
    });
  }

  // Слушаем изменения в базе и обновляем UI
  const tasksRef = ref(db, `tasks/${userId}`);
  onValue(tasksRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      renderTasks(data);
    } else {
      tasksContainer.innerHTML = '<p>Задач пока нет.</p>';
    }
  });

  // Добавление задачи по кнопке
  btnAdd.addEventListener('click', () => {
    addTask(inputTask.value);
  });

  // Добавление задачи по Enter
  inputTask.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      addTask(inputTask.value);
    }
  });

</script>
<style>
  body {
    background: #121212;
    color: #f0f0f0;
    font-family: sans-serif;
    padding: 20px;
  }
  #inputTask {
    width: 80%;
    padding: 10px;
    border-radius: 10px;
    border: none;
    margin-right: 10px;
    background: #1f1f1f;
    color: #f0f0f0;
  }
  #btnAdd {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    background: #6200ee;
    color: white;
    cursor: pointer;
  }
  #btnAdd:hover {
    background: #4500bb;
  }
  #tasks > div:hover {
    background: #333;
  }
</style>
</head>
<body>
  <h1>Ежедневник++</h1>
  <input type="text" id="inputTask" placeholder="Новая задача..." />
  <button id="btnAdd">Добавить задачу</button>
  <div id="tasks" style="margin-top: 20px;"></div>
</body>
</html>
